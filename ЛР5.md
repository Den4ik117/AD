# Лабораторная работа №5: Форматирование и линтинг проекта. Сборка образа проекта

Цель: познакомится со способами поддержки качества кода и сборки образа приложения.

## Применение линтеров и форматеров при локальной разработке

Установим в проект pre-commit, pylint, black и isort.

В корне проекта настраиваем прекоммит .pre-commit-config.yaml

```yaml
fail_fast: false
repos:
  - repo: local
    hooks:
      - id: system
        name: Black
        entry: black src
        pass_filenames: false
        language: system
  - repo: local
    hooks:
      - id: isort
        name: isort
        entry: isort src
        pass_filenames: false
        language: system
  - repo: local
    hooks:
      - id: system
        name: pylint
        entry: pylint src
        pass_filenames: false
        language: system
```

src – область, в которой лежит код проекта. Мы можем по отдельности запускать линтеры и форматеры командой из entry. 

Pylint конфигурируется с помощью файла .pylintrc и может содержать данную конфигурацию:

```
[BASIC]
init-hook='import sys; sys.path.append(".")'
disable =
    missing-function-docstring,
    missing-module-docstring,
    missing-class-docstring,
    too-few-public-methods,
    not-callable,
    attribute-defined-outside-init,
    ungrouped-imports,
    wrong-import-order,
    duplicate-code,
    unused-import,
    too-many-arguments,
    unused-argument,
    too-many-positional-arguments,
    import-outside-toplevel,
    too-many-instance-attributes,

ignore-paths =
    deploy,
    temp,
    build,
    tests,
    src/desk/repository/sqlalchemy/migration/alembic,

extension-pkg-whitelist=
    pydantic,
    orjson,

generated-members =
    [pydantic.PostgresDsn.build]
```

init-hook содержит код для того чтобы pylint понимал из какой директории нужно начинать искать импорты проекта.

В disable находятся исключения, которые мы не хотели бы чтоб в коде проверялись.

ignore-paths отвечает за папки в которых не нужно проверять код.

Extension-pkg-whitelist в pylint - это список имён пакетов или модулей, разделённых запятыми, из которых могут быть загружены расширения C.

Generated-members в Pylint - это список членов, которые устанавливаются динамически и пропускаются системой вывода pylint.

Black и isort конфигурируются следующим образом:

```
[tool.isort]
profile = "black"
known_first_party = ["src"]
skip = []

[tool.black]
line-length = 88
target-version = ['py313']
exclude = '''
/(
  \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | _build
  | buck-out
  | build
  | docker
  | config
  | temp
  | src/desc/repository/sqlalchemy/migration/alembic
)/
'''
```

Затем в проекте используем команду pre-commit install. После этого необходимо запустить pre-commit run --all-files и устранить, либо добавить в игнорирование предупреждения в проекте. Теперь каждый раз перед коммитом будет проверяться код в проекте.

## Сборка образа проекта

Для сбора образа проекта нам необходимо создать Dockerfile

```dockerfile
FROM python:3.13

WORKDIR /app

# Установка зависимостей
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Копирование приложения
COPY . .

# Настройка миграций
RUN chmod +x entrypoint.sh

ENTRYPOINT ["./entrypoint.sh"]
```

Сначала мы берём образ c [https://hub.docker.com](https://hub.docker.com) для того что бы у нас в проекте уже была нужная нам версия python или любой другой образ с необходимыми доработками.

Затем с помощью WORKDIR /app создаём рабочую папку для проекта.

Также в репозиторий копируем файлы с зависимостями и устанавливаем их. 

Копируем проект и прописываем скрипт для старта приложения.

Создаем `entrypoint.sh` для запуска проекта:

```shell
#!/bin/bash

# Ожидание готовности базы данных
while ! nc -z $DB_HOST $DB_PORT; do
    sleep 0.1
done

# Применение миграций
alembic upgrade head

# Запуск приложения
exec "$@"
```

Работа с uv может выглядеть:

```dockerfile
COPY uv.lock /src/uv.lock

COPY pyproject.toml /src/pyproject.toml

RUN uv sync --locked
```

А запуск  
`exec uv run uvicorn --reload --host $HOST --port $PORT --log-level debug app.infra.litestar.main:get_app`

Добавляем в `compose.yaml` проект и указываем, что он зависим от базы данных. Также указываем переменные, с которыми должна работать система. Переменные можно подтянуть с помощью pydantic-settings

```yaml
services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - # вставь тут переменные
    depends_on:
      - db
```

Затем запускаем проект с помощью `docker compose up -build` и проверяем работу на порту 8000.

